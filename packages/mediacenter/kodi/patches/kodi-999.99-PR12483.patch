From b2bc1caa9c1b27fc4ac25a3746cc0c838bc103f5 Mon Sep 17 00:00:00 2001
From: peak3d <pfau@peak3d.de>
Date: Thu, 13 Jul 2017 12:18:48 +0200
Subject: [PATCH] Fix endless loop when opening streams with missing
 information

---
 xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxClient.cpp | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxClient.cpp b/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxClient.cpp
index 4bb779986a3c..3276b5d3e4fe 100644
--- a/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxClient.cpp
+++ b/xbmc/cores/VideoPlayer/DVDDemuxers/DVDDemuxClient.cpp
@@ -369,6 +369,7 @@ void CDVDDemuxClient::RequestStream(CDemuxStream *stream, std::map<int, std::sha
   }
 
   std::shared_ptr<CDemuxStream> dStream = GetStreamInternal(stream->uniqueId);
+  bool updateExistingStream(dStream != nullptr);
 
   if (stream->type == STREAM_AUDIO)
   {
@@ -389,10 +390,10 @@ void CDVDDemuxClient::RequestStream(CDemuxStream *stream, std::map<int, std::sha
       streamAudio->m_parser = av_parser_init(source->codec);
       if (streamAudio->m_parser)
         streamAudio->m_parser->flags |= PARSER_FLAG_COMPLETE_FRAMES;
+      streamAudio->iSampleRate = source->iSampleRate;
+      streamAudio->iChannels = source->iChannels;
     }
 
-    streamAudio->iChannels       = source->iChannels;
-    streamAudio->iSampleRate     = source->iSampleRate;
     streamAudio->iBlockAlign     = source->iBlockAlign;
     streamAudio->iBitRate        = source->iBitRate;
     streamAudio->iBitsPerSample  = source->iBitsPerSample;
@@ -430,12 +431,12 @@ void CDVDDemuxClient::RequestStream(CDemuxStream *stream, std::map<int, std::sha
       streamVideo->m_parser = av_parser_init(source->codec);
       if (streamVideo->m_parser)
         streamVideo->m_parser->flags |= PARSER_FLAG_COMPLETE_FRAMES;
+      streamVideo->iHeight = source->iHeight;
+      streamVideo->iWidth = source->iWidth;
     }
 
     streamVideo->iFpsScale       = source->iFpsScale;
     streamVideo->iFpsRate        = source->iFpsRate;
-    streamVideo->iHeight         = source->iHeight;
-    streamVideo->iWidth          = source->iWidth;
     streamVideo->fAspect         = source->fAspect;
     streamVideo->iBitRate = source->iBitRate;
     streamVideo->stereo_mode     = "mono";
@@ -537,6 +538,12 @@ void CDVDDemuxClient::RequestStream(CDemuxStream *stream, std::map<int, std::sha
     dStream = streamGen;
   }
 
+  if (!updateExistingStream)
+  {
+    dStream->profile = stream->profile;
+    dStream->level = stream->level;
+  }
+
   dStream->uniqueId = stream->uniqueId;
   dStream->codec = stream->codec;
   dStream->codecName = stream->codecName;
